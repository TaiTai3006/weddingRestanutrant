{% extends 'layout.html' %} {% block title %} {% endblock %} {% block content %}
{% load mathfilters %} {% load humanize %}
<form
  className="form-columns"
  id="searchWedding"
  action="{% url 'search_party' %}"
  method="GET"
>
  <div class="row">
    <div class="col mb-3">
      <label for="tencodau" class="form-label">Tên cô dâu </label>
      <input
        type="text"
        class="form-control"
        id="tencodau"
        name="tencodau"
        placeholder="Tên cô dâu"
      />
    </div>
    <div class="col mb-3">
      <label for="tenchure" class="form-label">Tên chú rể </label>
      <input
        type="text"
        class="form-control"
        id="tenchure"
        name="tenchure"
        placeholder="Tên chú rể "
      />
    </div>

    <div class="col mb-3">
      <label for="maca" class="form-label">Ca</label>
      <select
        class="form-select"
        name="maca"
        id="maca"
        aria-label="Default select example"
      >
        <option value="">Chọn ca</option>
        {% for ca in shifts %}

        <option value="{{ ca.maca }}">{{ ca.tenca }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col mb-3">
      <label for="masanh" class="form-label">Sảnh</label>
      <select
        class="form-select"
        name="masanh"
        id="masanh"
        aria-label="Default select example"
      >
        <option value="">Chọn loại sảnh</option>
        {% for sanh in lobbyTypes %}
        <option value="{{sanh.maloaisanh}}">{{sanh.tenloaisanh}}</option>
        {% endfor %}
      </select>
    </div>
  </div>
  <div class="row">
    <div class="col mb-3">
      <label for="ngaydattiec" class="form-label">Ngày đặt tiệc</label>
      <input
        type="date"
        class="form-control"
        id="ngaydattiec"
        name="ngaydattiec"
        placeholder="Ngày đặt tiệc"
      />
    </div>
    <div class="col mb-3">
      <label for="ngaydaitiec" class="form-label">Ngày đãi tiệc </label>
      <input
        type="date"
        class="form-control"
        id="ngaydaitiec"
        name="ngaydaitiec"
        placeholder="Ngày đãi tiệc "
      />
    </div>

    <div class="col mb-3">
      <label for="soluongban" class="form-label">Số lượng bàn</label>
      <input
        type="number"
        class="form-control"
        id="soluongban"
        name="soluongban"
        placeholder="Số lượng bàn"
      />
    </div>
    <div class="col mb-3">
      <label for="soluongbandutru" class="form-label"
        >Số lượng bàn dự trữ</label
      >
      <input
        type="number"
        class="form-control"
        id="soluongbandutru"
        name="soluongbandutru"
        placeholder="Số lượng bàn dự trữ"
      />
    </div>
  </div>
  <div class="d-flex justify-content-end my-3">
    <button type="submit" id="searchButton" class="btn btn-outline-primary">
      Tìm kiếm
    </button>
    <button type="button" class="btn btn-outline-primary">Nhập lại</button>
  </div>
</form>

<div id="searchResult"></div>

<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>
  console.log(document.getElementById("searchResult"));

  function readFoodServiceDetailChecked(matieccuoi) {
    console.log("Mã tiệc cưới:", matieccuoi);
    const xhttp = new XMLHttpRequest();

    xhttp.onload = function () {
      if (this.status >= 200 && this.status < 300) {
        var responseData = JSON.parse(this.responseText);
        console.log(responseData);
     
        
      } else {
        console.error("Yêu cầu không thành công. Mã lỗi:", this.status);
      }
    };

    const url = `searchFoodService/?matieccuoi=${matieccuoi}`;

    xhttp.open("GET", url);
    xhttp.setRequestHeader("Content-type", "application/json");
    xhttp.send();
  }
  function readSearchResult() {
    const xhttp = new XMLHttpRequest();

    xhttp.onload = function () {
      if (this.status >= 200 && this.status < 300) {
        document.getElementById("searchResult").innerHTML = this.responseText;
        console.log(document.getElementById("searchResult"));
        console.log(document.getElementById("modal-add-food"));
        document
          .getElementById("modal-add-food")
          .addEventListener("click", function () {
            console.log("hellooo");
            var wedding_id = this.getAttribute("data-wedding-id");
            console.log(wedding_id);
            readFoodServiceDetailChecked(wedding_id);
          });

        // Xử lý dữ liệu nếu cần
      } else {
        console.error("Yêu cầu không thành công. Mã lỗi:", this.status);
      }
    };

    // Lấy các giá trị từ các trường nhập liệu
    var tenchure = document.getElementById("tenchure").value || null;
    var tencodau = document.getElementById("tencodau").value || null;
    var maca = document.getElementById("maca").value || null;
    var masanh = document.getElementById("masanh").value || null;
    var ngaydattiec = document.getElementById("ngaydattiec").value || null;
    var ngaydaitiec = document.getElementById("ngaydaitiec").value || null;
    var soluongban = document.getElementById("soluongban").value || null;
    var soluongbandutru =
      document.getElementById("soluongbandutru").value || null;
    var url = "searchParty/?";
    if (tenchure) {
      url += "tenchure=" + encodeURIComponent(tenchure) + "&";
    }
    if (tencodau) {
      console.log("tencodau");
      url += "tencodau=" + encodeURIComponent(tencodau) + "&";
    }
    if (maca) {
      url += "maca=" + encodeURIComponent(maca) + "&";
    }
    if (masanh) {
      url += "masanh=" + encodeURIComponent(masanh) + "&";
    }
    if (ngaydattiec) {
      url += "ngaydattiec=" + encodeURIComponent(ngaydattiec) + "&";
    }
    if (ngaydaitiec) {
      url += "ngaydaitiec=" + encodeURIComponent(ngaydaitiec) + "&";
    }
    if (soluongban) {
      url += "soluongban=" + encodeURIComponent(soluongban) + "&";
    }
    if (soluongbandutru) {
      url += "soluongbandutru=" + encodeURIComponent(soluongbandutru) + "&";
    }

    // Loại bỏ dấu & cuối cùng nếu có
    url = url.replace(/&$/, "");
    console.log(url);
    // Mở một yêu cầu GET đến URL
    xhttp.open("GET", url);
    xhttp.setRequestHeader("Content-type", "application/json");

    // Gửi yêu cầu
    xhttp.send();
  }
  document
    .querySelectorAll("#searchWedding input, #searchWedding select")
    .forEach((input) => {
      input.addEventListener("input", function () {
        readSearchResult();
      });
    });
  const apiUrlFoods = "http://127.0.0.1:8000/foods/";
  const apiUrlServices = "http://127.0.0.1:8000/services/";
  const fetchFoods = async () => {
    try {
      const response = await axios.get(apiUrlFoods);
      return response.data;
    } catch (error) {
      console.error("Error fetching wedding foods:", error);
      throw error;
    }
  };
  const fetchServices = async () => {
    try {
      const response = await axios.get(apiUrlServices);
      return response.data;
    } catch (error) {
      console.error("Error fetching wedding services:", error);
      throw error;
    }
  };
  window.onload = async () => {
    try {
      readSearchResult();
      const weddingFoods = await fetchFoods();
      const weddingServices = await fetchServices();

      const chitiet_mamonan = document.querySelectorAll("#chitiet_mamonan");
      chitiet_mamonan.forEach(async (element) => {
        const mamonan = element.textContent.trim();

        const matchingFood = weddingFoods.find(
          (food) => food.mamonan === mamonan
        );

        if (matchingFood) {
          element.textContent = matchingFood.tenmonan;
        }
        const chitiet_madichvu = document.querySelectorAll("#chitiet_madichvu");
        chitiet_madichvu.forEach(async (element) => {
          const madichvu = element.textContent.trim();

          const matchingService = weddingServices.find(
            (dichvu) => (dichvu.madichvu = madichvu)
          );

          if (matchingService) {
            element.textContent = matchingService.tendichvu;
          }
        });
      });
    } catch (error) {
      console.error("Error handling hall types:", error);
    }
  };

  const editButtons = document.querySelectorAll("#editButton");
  const saveButtons = document.querySelectorAll("#saveButton");

  // Function to enable form fields for editing
  function enableEditing(button) {
    const formFields = button
      .closest(".wedding_info")
      .querySelectorAll("input[type='text']");

    formFields.forEach(function (inputField) {
      inputField.disabled = false;
    });
    document.getElementById("modal-add-food").style.display = "block";
    document.getElementById("modal-add-service").style.display = "block";

    button.style.display = "none";
    button.nextElementSibling.style.display = "block";
  }

  // Function to disable form fields after editing
  function disableEditing(button) {
    const formFields = button
      .closest(".wedding_info")
      .querySelectorAll("input[type='text']");

    formFields.forEach(function (inputField) {
      inputField.disabled = true;
    });
    document.getElementById("modal-add-food").style.display = "none";
    document.getElementById("modal-add-service").style.display = "none";
    button.style.display = "none";
    button.previousElementSibling.style.display = "block";
  }

  editButtons.forEach(function (editButton) {
    editButton.addEventListener("click", function () {
      enableEditing(this);
    });
  });

  saveButtons.forEach(function (saveButton) {
    saveButton.addEventListener("click", function () {
      disableEditing(this);
    });
  });
</script>

{% endblock %}
