{% extends 'layout.html' %} {% block title %} {% endblock %} 
{% block content %}

{% load mathfilters %} {% load humanize %}
    <style>
        .payment-container{
            overflow: scroll;
            height: 600px;
        }
        .payment-container::-webkit-scrollbar{
            display: none;
        }
        .info, .payment {
            margin-bottom: 20px;
        }
        .info p, .payment p {
            margin: 5px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }
        table, th, td {
            border: 1px solid #ccc;
        }
        th, td {
            padding: 5px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .totals {
            text-align: right;
        }
        .totals td {
            border: none;
        }
        .btn-container {
            display: flex;
            justify-content: space-between;
        }
        .btn-container button, .btn-container select {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        .btn-container button:hover, .btn-container select:hover {
            background-color: #0056b3;
        }
    </style>

    <div class="payment-container p-2">
        <form id="paymentForm">
            <input type="hidden" name="mahoadon" id="mahoadon">
            <input type="hidden" name="ngaythanhtoan" id="ngaythanhtoan" value="{{ wedding.ngaythanhtoan }}">
            <input type="hidden" name="matieccuoi" id="matieccuoi" value="{{ wedding.matieccuoi }}">
            <input type="hidden" name="username" id="username" value="{{ wedding.username }}"> <!-- Assuming the username is admin -->
            <input type="hidden" name="tongtiendichvu" id="tongtiendichvu" value="{{ wedding.tongtiendichvu }}">
            <input type="hidden" name="tienphat" id="tienphat" value="{{ wedding.tienphat }}"> <!-- Assuming no penalty -->
            <input type="hidden" name="tongtienhoadon" id="tongtienhoadon" value="{{ wedding.tongtienhoadon }}">
            <input type="hidden" name="conlai" id="conlai" value="{{ wedding.conlai }}"> <!-- Replace with the actual remaining amount -->
        
            <!-- Add service details fields as hidden inputs -->
            {% for service in services %}
            <input type="hidden" name="danhsachdichvu[{{ forloop.counter }}][madichvu]" value="{{ service.madichvu }}">
            <input type="hidden" name="danhsachdichvu[{{ forloop.counter }}][soluong]" value="{{ service.soluong }}">
            <input type="hidden" name="danhsachdichvu[{{ forloop.counter }}][giatien]" value="{{ service.dongiadichvu }}">
            {% endfor %}
            
            <div class="payment-container p-2">
                <h2 class="text-center py-3">XÁC NHẬN THÔNG TIN HOÁ ĐƠN</h2>
                <div class="info row justify-content-between">
                    <div class="col-3">
                        <p>Ngày thanh toán: {{wedding.ngaythanhtoan}}</p>
                        <p>Tên cô dâu: {{wedding.tencodau}}</p>
                        <p>Tên chú rể: {{wedding.tenchure}}</p>
                    </div>
                    <div class="col-3">
                        <p>Ngày đãi tiệc: {{wedding.ngaydaitiec}}</p>
                        <p>Số lượng bàn: {{wedding.soluongban}}</p>
                        <p>Đơn giá bàn: {{wedding.dongiaban|intcomma}}</p>
                    </div>
                    <div class="col-3">
                        <p>Tổng tiền bàn: {{wedding.tongtienban|intcomma}}</p>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Mã dịch vụ</th>
                            <th>Tên dịch vụ</th>
                            <th>Số lượng</th>
                            <th>Đơn giá</th>
                            <th>Thành tiền</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for service in services %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ service.madichvu }}</td>
                            <td>{{ service.tendichvu }}</td>
                            <td>{{ service.soluong }}</td>
                            <td>{{ service.dongiadichvu }} đ</td>
                            <td>{{ service.dongiadichvu|floatformat|mul:service.soluong|intcomma }} đ</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <table class="totals">
                    <tbody>
                        <tr>
                            <td>Tổng tiền dịch vụ:</td>
                            <td>{{wedding.tongtiendichvu|intcomma}}</td>
                        </tr>
                        <tr>
                            <td>Tiền phạt (%)</td>
                            <td>{{wedding.tienphat|intcomma}}</td>
                        </tr>
                        <tr>
                            <td>Tổng tiền hoá đơn:</td>
                            <td>{{wedding.tongtienhoadon|intcomma }}</td>
                        </tr>
                        <tr>
                            <td>Tiền cọc (50%):</td>
                            <td>{{wedding.tiendatcoc|intcomma}}</td>
                        </tr>
                        <tr>
                            <td>Số tiền cần thanh toán:</td>
                            <td>{{wedding.tongtienhoadon|sub:wedding.tiendatcoc|intcomma}}</td>
                        </tr>
                    </tbody>
                </table>
                <div class="payment d-flex justify-content-start">
                    <p>Phương thức thanh toán:</p>
                    <select id="paymentMethod">
                        <option value="cash">Tiền mặt</option>
                        <option value="credit">Thẻ tín dụng</option>
                        <option value="bank">Chuyển khoản</option>
                    </select>
                </div>
                <div class="btn-container">
                    <button type="button" onclick="history.back()">Quay lại</button>
                    <button type="submit">Tiếp tục</button>
                </div>
            </div>
        </form>
    </div>
    <script>
      document.getElementById('paymentForm').addEventListener('submit', function(event) {
    event.preventDefault();
    const form = event.target;

    const invoiceData = {
        ngaythanhtoan: form.ngaythanhtoan.value,
        tongtiendichvu: form.tongtiendichvu.value,
        tienphat: form.tienphat.value,
        tongtienhoadon: form.tongtienhoadon.value,
        conlai: form.conlai.value,
        matieccuoi: form.matieccuoi.value,
        username: form.username.value,
        danhsachdichvu: []
    };

    const services = {};
    form.querySelectorAll('[name^="danhsachdichvu"]').forEach(input => {
        const match = input.name.match(/danhsachdichvu\[(\d+)\]\[(\w+)\]/);
        if (match) {
            const index = match[1];
            const field = match[2];
            if (!services[index]) {
                services[index] = {};
            }
            services[index][field] = input.value;
        }
    });

    invoiceData.danhsachdichvu = Object.values(services);

    axios.post('/paymentInvoice/', invoiceData)
        .then(response => {
            alert('Invoice created successfully!');
            // Optionally redirect or clear form
        })
        .catch(error => {
            console.error('There was an error!', error);
        });
});

    
    </script>
    
{% endblock %}